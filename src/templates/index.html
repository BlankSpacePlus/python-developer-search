<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <title>Code Search in StackOverflow</title>
    <link rel="shortcut icon" type="image/x-icon" href="static/img/favicon.ico"/>
    <link rel="stylesheet" type="text/css" href="static/lib/bootstrap-4.1.3-dist/css/bootstrap.css"/>
    <link rel="stylesheet" type="text/css" href="static/css/index.css"/>
    <link rel="stylesheet" type="text/css" href="static/css/a11y-light.css"/>
    <link rel="stylesheet" type="text/css" href="static/css/load.css"/>
    <link rel="stylesheet" type="text/css" href="static/css/like.css"/>
    <link rel="stylesheet" type="text/css" href="static/css/prism.css"/>
</head>

<body>
<header>
    <div class="navbar navbar-dark bg-dark shadow-sm">
        <div class="container d-flex justify-content-between">
            <a class="navbar-brand align-items-center" href="#">
                <img src="static/img/search-white.png" width="30" height="30" class="d-inline-block align-top"/>
                SO Search
            </a>
        </div>
    </div>
</header>

<main role="main">
    <section class="jumbotron text-center not-search">
        <div class="container">
            <h1 class="jumbotron-heading">Code Search in StackOverflow</h1>
            <div class="input-group mt-5 mb-3 position-relative">
                <input type="text" id="keyword" class="form-control keyword-input" placeholder="Please input a query"
                       autocomplete="off"
                       aria-describedby="button-addon2"/>
                <div class="input-group-append">
                    <button id="searchPaper" class="btn btn-outline-secondary px-4" type="button" style="z-index: 0;"
                            onClick="fun()">Search
                    </button>
                </div>
            </div>
            <div class="run_time input-group mt-5 mb-3 position-relative" id="run_time"
                 style="margin-top: 1rem !important;font-family: SYSTEM-UI;;color: gray;font-size: 0.8em">
            </div>
        </div>
    </section>
    <section id="win8s"
             style="top: 0px; left: 0px; position: absolute; width: 100%; height: 100%; backdrop-filter: blur(2px); z-index:4;">
        <div class="windows8" id="windows8" style="position: absolute; bottom: 50%; left: 45%; width: 10%;">
            <div class="wBall" id="wBall_1">
                <div class="wInnerBall"></div>
            </div>
            <div class="wBall" id="wBall_2">
                <div class="wInnerBall"></div>
            </div>
            <div class="wBall" id="wBall_3">
                <div class="wInnerBall"></div>
            </div>
            <div class="wBall" id="wBall_4">
                <div class="wInnerBall"></div>
            </div>
            <div class="wBall" id="wBall_5">
                <div class="wInnerBall"></div>
            </div>
        </div>
    </section>

    <div id="resultSection" class="py-5 bg-light" style="position: absolute; width: 70%; left: 15%;">
        <div class="container">
        </div>
        <div class="final" id="final">
        </div>
    </div>
</main>

<script src="static/js/highlight.pack.js"></script>
<script src="static/lib/jquery-3.3.1.min.js"></script>
<script src="static/js/prism.js"></script>

<script>
    <!--关闭自动高亮显示，手动控制代码高亮时机-->
    window.Prism = window.Prism || {};
    Prism.manual = true;
</script>
<script>
    function fun() {
        document.getElementById("keyword").blur()
        document.getElementById("searchPaper").blur()
        $("#run_time").empty();
        $("#final").empty();
        key = $("#keyword").val()
        if (key === "") {
            $("#win8s").hide;
            alert("Please input a query first!")
            return;
        }
        $("#win8s").show();
        $.getJSON({
            url: "http://127.0.0.1:5000/search/" + key,
            success: function (result) {
                // 获取返回的数据中我们需要的部分
                var res = result['result']  // 获得数据
                var t = result['run_time']  // 运行时间
                //var cnt = res.length;
                var cnt = result["result_num"]  // 样本数量
                $("#run_time").append(cnt + " results found with " + t + " seconds.")
                var j = 0;
                if (cnt === 0) {
                    // 没有结果特殊处理
                    var line = "--> Your query doesn't match any results !!!"
                    $("#final").append("<div id=div" + j + "><div><pre style=' float:left; width:85%; background-color: antiquewhite;' id=" + j + ">" + " result " + j + "\n" + "<code class= 'java' ><textarea style=\"word-break:break-all;background-color:#f8f9fa !important; float:right; width:100%;height:300px;\">" + line + "</textarea></code></pre></div> <div style='background-color:#f8f9fa !important; float:right; width:15%;' id= divdiv" + j + "></div><div style='clear:both'></div></div>");
                }
                res.forEach(function (foo) {
                    
                    console.log(foo);

                    if (foo["data_type"] === "qa") {
                        var i = 0;
                        var t = 1;  // 空格的数量
                        var line = "question: \n" + foo["result_data"]["query"] + "\n\n" + "code: \n" + foo["result_data"]["code"] + "\n";
                        j = j + 1;
                        $("#final").append("<div id=div" + j + "><div><pre style=' float:left; width:85%; background-color: antiquewhite;' id=" + j + ">" + " result " + j + "\n" + "<code class= 'java' ><textarea style=\"word-break:break-all;background-color:#f8f9fa !important; float:right; width:100%;height:300px;\">" + line + "</textarea></code></pre></div> <div style='background-color:#f8f9fa !important; float:right; width:15%;' id= divdiv" + j + "></div><div style='clear:both'></div></div>");
                        $("#divdiv" + j).append("<div class='dian'><div id='like' onclick='like_function()'><img src='static/img/like.gif'><div id='num1'>3</div></div><div id='dislike' onclick='dislike_function()'><img src='static/img/dislike.gif'><div id='num2'>3</div></div></div>")
                    } else if (foo["data_type"] === "code") {
                        foo["result_data"] = $.trim(foo["result_data"]);
                        foo["result_data"] = foo["result_data"].replace(/[<">']/g, (a) => {
                            return {
                                "&": "&amp",
                                "<": "&lt",
                                ">": "&gt",
                                '"': '&quot',
                                "'": '&#39',
                                "/": '&#x2F'
                            }[a]
                        });
                        var i = 0;
                        var t = 0;
                        var ans = "";
                        var line = "";
                        for (i = 0; i < foo["result_data"].length; ++i) {
                            ans += foo["result_data"][i];
                            if (foo["result_data"][i] == "{") {
                                line += "    ".repeat(t) + ans + "\n";
                                ans = "";
                                ++t;
                            }
                            if (foo["result_data"][i] == ";") {
                                line += "    ".repeat(t) + ans + "\n";
                                ans = "";
                            }
                            if (foo["result_data"][i] == "@"){
                                ans = ans.substr(0,ans.length-1) + ";"
                            }
                            if (foo["result_data"][i] == "}") {
                                --t;
                                if (t < 0)
                                    t = 0;
                                line += "    ".repeat(t) + ans + "\n";
                                ans = "";
                            }
                        }
                        $("#final").append("<pre class='line-numbers'><code class='language-java'>"+line+"</code></pre>");
                        // 此时已经加载完毕，手动高亮所有代码块
                        Prism.highlightAll();
                    }
                });
                $("section.jumbotron").animate({
                    margin: "0"
                });
                $("#resultSection").show();
                $("#win8s").hide();
            }
        });
    }

</script>
<script>
    var wh = document.getElementById("windows8");
    wh.style.height = getComputedStyle(wh).width;
    $(document).keyup(function (event) {
        if (event.keyCode === 13) {
            fun();
        }
    });
    $(document).ready(function () {
        // 页面刚开始隐藏搜索结果的部分
        $("#resultSection").hide();
        $("#win8s").hide();
    });

</script>
<script>
    var flag1 = 0;
    var flag2 = 0;

    function like_function() {
        var like = document.getElementById('like');
        var num1 = document.getElementById('num1');
        if (flag1 === 0 && flag2 === 0) {
            num1.innerHTML++;
            flag1 = 1;
            document.getElementById('like').style.background = '#F3B3B3';
        } else if (flag1 === 1) {
            num1.innerHTML--;
            flag1 = 0;
            document.getElementById('like').style.background = '#F3F3F3';
        }
    }

    function dislike_function() {
        var dislike = document.getElementById('dislike');
        var num2 = document.getElementById('num2');
        if (flag2 === 0 && flag1 === 0) {
            num2.innerHTML++;
            flag2 = 1;
            document.getElementById('dislike').style.background = '#B3B3B3';
        } else if (flag2 === 1) {
            num2.innerHTML--;
            flag2 = 0;
            document.getElementById('dislike').style.background = '#F3F3F3';
        }
    }
</script>

</body>

</html>
